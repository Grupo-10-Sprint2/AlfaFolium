<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard AlfaFolium</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet">

  <link rel="stylesheet" href="./css/styleDashboard.css">
  <link rel="stylesheet" href="./css/styleRelogio.css">
  <script src="https://kit.fontawesome.com/800a4bbd88.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

  <header>
    <div class="headerBox">
      <div class="logoBox">
        <a onclick="sairDashboard()"><img class="logoImg" src="./assets/Logo/logoNav.png"></a>
      </div>
    </div>
  </header>

  <div class="boxGreen">
    <div class="boxContent">
      <div class="boxInfos1">
        <div class="boxLegenda">
          <p>Legendas</p>
        </div>
        <div class="boxLegendaNome">
          <p></p>
          <div class="boxNome">
            <h2>Estufa 1</h2>
          </div>
          <div class="legendas">
            <div class="legendaAlerta">
              <h2>Alerta</h2>
            </div>
            <div class="legendaAtencao">
              <h2>Atenção</h2>
            </div>
            <div class="legendaEstavel">
              <h2>Estável</h2>
            </div>
          </div>
        </div>
        <div class="boxDadosCapturados">
          <div class="cardTemp">
            <div class="cardTempTitle">
              <h2>Temperatura Atual da Estufa</h2>
              <h2 id="exibirTemperatura"></h2>
            </div>
          </div>
          <div class="cardUmi">
            <div class="cardUmiTitle">
              <h2>Umidade Atual da Estufa</h2>
              <h2 id="exibirUmidade"></h2>
            </div>
          </div>
        </div>
      </div>
      <div class="boxInfos2">
        <div class="boxDadosNecessarios">

          <div class="boxTitleDados">
            <h1> Dados Necessários </h1>
          </div>

          <div class="boxVerdeDados">
            <div class="boxVerdeDados1">
              <div class="boxParametrosIdeais">
                <div class="parametrosTitle">
                  <h2> Parâmetros Ideais da Estufa </h2>
                </div>
                <div class="parametroTemp">
                  <div class="parametroTempTitle">
                    <h3> Temperatura </h3>
                  </div>
                  <div class="parametroTempMin">
                    <p>Min</p>
                    <h3 id="exibirTemperaturaMin"></h3>
                  </div>
                  <div class="parametroTempMax">
                    <p>Max</p>
                    <h3 id="exibirTemperaturaMax"></h3>
                  </div>
                </div>
                <div class="parametroUmi">
                  <div class="parametroUmiTitle">
                    <h3> Umidade </h3>
                  </div>
                  <div class="parametroUmiMin">
                    <p>Min</p>
                    <h3 id="exibirUmidadeMin"></h3>
                  </div>
                  <div class="parametroUmiMax">
                    <p>Max</p>
                    <h3 id="exibirUmidadeMax"></h3>
                  </div>
                </div>
              </div>
            </div>

            <div class="boxVerdeDados2">
              <div class="boxVerdeDados2_2">
                <div class="boxTempExterna">
                  <div class="tempExtTitle">
                    <h3> Temperatura Externa </h3>
                  </div>
                  <h1> 28°C </h1>
                </div>
                <div class="boxLocalidade">
                  <div class="localidadeTitle">
                    <h3> Localidade </h3>
                  </div>
                  <h3> São Paulo - SP </h3>
                </div>
              </div>
              <div class="boxHorario">
                <div class="horarioTitle">
                  <h3> Data de Registro Atual </h3>
                </div>
                <div id="relogio">
                  <h1 id="exibirHorario"></h1>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
    <div class="graficosContent">
      <div class="grafico1">
        <div>
          <canvas id="myChart1"></canvas>
        </div>
      </div>
      <div class="grafico2">
        <div>
          <canvas id="myChart2"></canvas>
        </div>
      </div>
    </div>
  </div>


</body>

</html>

<script src="./js/scriptDashboard.js"></script>


<script>
  const ctx1 = document.getElementById('myChart1');
  const ctx2 = document.getElementById('myChart2');

  let numLeituras1 = 0; // Variável para rastrear o número de leituras
  let numLeituras2 = 0; // Variável para rastrear o número de leituras




  function adicionarDadosCapturados(temperatura, umidade) {
    if (numLeituras1 % 10 === 0) {
      graficoTemp.data.labels = [];
      graficoTemp.data.datasets[0].data = [];
    }

    graficoTemp.data.datasets[0].data.push(temperatura);
    graficoTemp.data.labels.push(`Leitura ${numLeituras1}`);
    graficoTemp.update();
    numLeituras1++;

    if (numLeituras2 % 10 === 0) {
      graficoUmi.data.labels = [];
      graficoUmi.data.datasets[0].data = [];
    }

    graficoUmi.data.datasets[0].data.push(umidade);
    graficoUmi.data.labels.push(`Leitura ${numLeituras2}`);
    graficoUmi.update();
    numLeituras2++;
  }




  var graficoTemp = new Chart(ctx1, {
    type: 'line',
    data: {
      labels: [], // Adicione os labels aqui
      datasets: [{
        label: 'Temperatura (°C)',
        data: [], // Adicione os dados aqui
        borderColor: '#f5240c', // Cor da linha branca
        borderWidth: 3,
        cubicInterpolationMode: 'monotone', // Linha curva suave
        tension: 0.4, // Ajuste a tensão para suavizar as curvas
        fill: true, // Preencher a área abaixo da linha
        backgroundColor: 'rgba(240, 44, 22, 0.5)' // Cor de fundo transparente
      }]
    },
    options: {
      plugins: {
        legend: {
          labels: {
            color: '#ffffff' // Cor das fontes da legenda
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 50, // Ajuste o valor máximo da escala y conforme necessário
          ticks: {
            color: '#ffffff', // Cor das fontes do eixo y
            font: {
              size: 14 // Tamanho da fonte para o eixo y
            }
          },
          grid: {
            color: 'rgba(255, 255, 255, 0.2)' // Cor dos traços de fundo do eixo y
          }
        },
        x: {
          ticks: {
            color: '#ffffff', // Cor das fontes do eixo x
            font: {
              size: 14 // Tamanho da fonte para o eixo x
            }
          },
          grid: {
            color: 'rgb(255, 255, 255, 0.2)' // Cor dos traços de fundo do eixo x
          }
        }
      }
    }
  });




  var graficoUmi = new Chart(ctx2, {
    type: 'bar',
    data: {
      labels: [], // Adicione os labels aqui
      datasets: [{
        label: 'Umidade (%)',
        data: [], // Adicione os dados aqui
        backgroundColor: [
          'rgba(93, 133, 194, 0.8)', // Azul vibrante
        ], // Cores de fundo divertidas
        borderColor: '#0063fa', // Cor da borda branca
        borderWidth: 3
      }]
    },
    options: {
      plugins: {
        legend: {
          labels: {
            color: '#ffffff' // Cor das fontes da legenda
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          ticks: {
            color: '#ffffff', // Cor das fontes do eixo y
            font: {
              size: 14 // Tamanho da fonte para o eixo y
            }
          },
          grid: {
            color: '#444444' // Cor dos traços de fundo do eixo y
          }
        },
        x: {
          ticks: {
            color: '#ffffff', // Cor das fontes do eixo x
            font: {
              size: 14 // Tamanho da fonte para o eixo x
            }
          },
          grid: {
            color: '#444444' // Cor dos traços de fundo do eixo x
          }
        }
      }
    }
  });






  setInterval(exibirTemperaturaUmidade, 3000);
  function exibirTemperaturaUmidade() {
    fetch("/grafico/coletarTemperaturaUmidade")
      .then(resposta => {
        console.log(resposta);

        if (resposta.ok) {
          resposta.json().then(res => {
            console.log(res[0]);

            let temperatura = Math.trunc(Number(res[0].temperatura));
            let umidade = Math.trunc(Number(res[0].umidade));
            let horario = res[0].horario;
            let temperaturaMax = Math.trunc(Number(res[0].temperaturaMax));
            let temperaturaMin = Math.trunc(Number(res[0].temperaturaMin));
            let umidadeMax = Math.trunc(Number(res[0].umidadeMax));
            let umidadeMin = Math.trunc(Number(res[0].umidadeMin)); 

            sessionStorage.TEMPERATURA = temperatura;
            sessionStorage.UMIDADE = umidade;

            let exibirTemperatura = document.getElementById("exibirTemperatura");
            let exibirUmidade = document.getElementById("exibirUmidade");
            let exibirHorario = document.getElementById("exibirHorario");
            let exibirTemperaturaMax = document.getElementById("exibirTemperaturaMax");
            let exibirTemperaturaMin = document.getElementById("exibirTemperaturaMin");
            let exibirUmidadeMax = document.getElementById("exibirUmidadeMax");
            let exibirUmidadeMin = document.getElementById("exibirUmidadeMin");

            exibirTemperatura.innerHTML = `${temperatura}°C`;
            exibirUmidade.innerHTML = `${umidade}%`;
            exibirTemperaturaMax.innerHTML = `${temperaturaMax}°C`;
            exibirTemperaturaMin.innerHTML = `${temperaturaMin}°C`;
            exibirUmidadeMax.innerHTML = `${umidadeMax}%`;
            exibirUmidadeMin.innerHTML = `${umidadeMin}%`;
            exibirHorario.innerHTML = `${horario.slice(0,10)}`; 

            let tituloTemperatura = document.querySelector(".cardTempTitle");
            let tituloUmidade = document.querySelector(".cardUmiTitle");


            let corTemperatura = `#008000`;

            // VALIDAÇÃO TEMPERATURA
            if ((temperatura <= temperaturaMax - 1 && temperatura >= temperaturaMax - 2) || (temperatura >= temperaturaMin + 1 && temperatura <= temperaturaMin + 2)) {
              corTemperatura = `#FFA500`;
            }

            if (temperatura >= temperaturaMax - 1 || temperatura <= temperaturaMin + 1) {
              corTemperatura = `#FF0000`;
            }

            let corUmidade = `#008000`;

            // VALIDAÇÃO UMIDADE
            if ((umidade <= umidadeMax - 2 && umidade >= umidadeMax - 3) || (umidade >= umidadeMin + 2 && umidade <= umidadeMin + 3)) {
              corUmidade = `#FFA500`;
            }

            if (umidade >= umidadeMax - 1 || umidade <= umidadeMin + 1) {
              corUmidade = `#FF0000`;
            }

            // SAÍDA PARA O USUÁRIO
            tituloTemperatura.style.backgroundColor = `${corTemperatura}`;
            tituloUmidade.style.backgroundColor = `${corUmidade}`;
            adicionarDadosCapturados(temperatura, umidade)
          });
        } else {
          console.log(`JSON não coletado`);
        }
      })
      .catch(function (resposta) {
        console.error(resposta);
      });
  }
</script>