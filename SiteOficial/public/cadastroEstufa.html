<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Estufa - Alfa Folium</title>
    <link rel="stylesheet" href="./css/styleCadastroEstufa.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Ysabeau:ital,wght@0,1..1000;1,1..1000&display=swap"
        rel="stylesheet">

    <script src="https://kit.fontawesome.com/800a4bbd88.js" crossorigin="anonymous"></script>
</head>


<body>

    <div id="blurTela" class="blurTela">

    </div>

    <div class="alertaBox">
        <h1 class="textAlerta"> Cadastro inválido! </h1>
        <div onclick="fecharAviso()" class="btnFechar">
            <h3>X</h3>
        </div>
        <div class="mensagemBox">
        </div>
        <div class="alfaceAlerta"><img src="./assets/assetsCadastro/alface.png"></div>
    </div>

    <div class="headerBox">
        <div class="boxLogo">

            <img src="./assets/assetsDashboard/logoNav.png">

        </div>
        <div class="boxMenu">

            <nav role="navigation">
                <div id="menuToggle">
                    <input type="checkbox">

                    <span></span>
                    <span></span>
                    <span></span>

                    <ul class="menu" id="menu">
                        <li><img src="./assets/assetsMaster/iconHome.png"><a href="http://localhost:3333/telaMaster.html">Home</a></li>
                        <li><img src="./assets/assetsMaster/iconEmpresa.png"><a href="http://localhost:3333/cadastroEmpresa.html">Cadastro de Usuários</a></li>
                        <li><img src="./assets/assetsMaster/iconEstufa.png"><a href="http://localhost:3333/cadastroEstufa.html">Cadastro de Estufa</a></li>
                        <li><img src="./assets/assetsMaster/iconSuporte.png"><a href="http://localhost:8080">Suporte</a></li>
                        <li><img src="./assets/assetsMaster/iconSair.png"><a href="index.html">Sair</a></li>
                    </ul>
                </div>
            </nav>

        </div>
    </div>



    <div class="boxContent">
        <div class="boxGreen">
            <div class="boxCadastro">
                <div class="quadrado_titulo">
                    <div class="titulo">
                        <p>Insira os dados da estufa</p>
                    </div>
                </div>
                <div class="boxInputs">
                    <div class="boxInput">
                        <h3 class="boxInputTitle">Tamanho:</h3>
                        <input placeholder="Hectares" class="input" id="input_tamanhoEstufa" type="number">
                    </div>
                    <div class="boxInput">
                        <h3 class="boxInputTitleS">Status:</h3>
                        <select placeholder="joao@email.com" class="select" id="select_statusEstufa" type="text">
                            <option value="">---</option>
                            <option value="Ativa">Ativa</option>
                            <option value="Inativa">Inativa</option>
                        </select>
                    </div>
                    <div class="boxInput">
                        <h3 class="boxInputTitle">Empresa:</h3>
                        <select placeholder="012.345.678-90" class="select" id="select_empresa" type="text">
                            <option value="">---</option>
                        </select>
                    </div>
                    <div class="boxInput">
                        <h3 class="titleParametro">Parâmetros:</h3>
                        <div class="boxParametros">
                            <div class="boxParametros1">
                                <div class="tempTitle">
                                    <h3>Temperatura</h3>    
                                </div>
                                <input placeholder="Máx." class="input_Parametro" type="text" id="input_TemperaturaMax">
                                <input placeholder="Mín." class="input_Parametro" type="text" id="input_TemperaturaMin">
                            </div>
                            <div class="boxParametros2">
                                <div class="umiTitle">
                                    <h3>Umidade</h3>    
                                </div>
                                <input placeholder="Máx." class="input_Parametro" type="text" id="input_umidadeMax">
                                <input placeholder="Mín." class="input_Parametro" type="text" id="input_umidadeMIn">
                            </div>
                        </div>
                    </div>
                    <button class="btn_cadastrar" onclick="cadastrarEstufa()">
                        <h3> Cadastrar </h3>
                    </button>
                </div>
            </div>
        </div>
    </div>
    </div>
</body>

</html>

<script src="./js/scriptCadastroEstufa.js"></script>

<script>


    function mostrarAlerta(mensagemAlerta) {
        let boxAlerta = document.querySelector('.alertaBox');
        let boxMensagem = document.querySelector('.mensagemBox');
        let blurTela = document.getElementById('blurTela');

        boxMensagem.innerHTML = `<p>${mensagemAlerta}</p>`;
        blurTela.style.display = 'block';
        boxAlerta.classList.add('aparecer');
    }

    function fecharAviso() {
        let boxAlerta = document.querySelector('.alertaBox');
        let blurTela = document.getElementById('blurTela');

        boxAlerta.classList.remove('aparecer');
        setTimeout(() => {
            blurTela.style.display = 'none';
        }, 500);
    }

    function marcarErro(input) {
        input.style.border = 'solid 2px #FF0000';
        setTimeout(() => {
            input.style.border = '';
        }, 3000);
    }


    function carregarEmpresas() {
        fetch('/empresas/listar')
            .then(response => response.json())
            .then(data => {
                let selectEmpresa = document.getElementById('select_empresa');
                data.forEach(empresa => {
                    let option = document.createElement('option');
                    option.value = empresa.idEmpresa;
                    option.textContent = empresa.nome;
                    selectEmpresa.appendChild(option);
                });
            })
            .catch(error => console.error('Erro ao carregar empresas:', error));
    }

    document.addEventListener('DOMContentLoaded',carregarEmpresas())


    function cadastrarEstufa() {
        let tamanhoInput = document.getElementById('input_tamanhoEstufa');
        let statusInput = document.getElementById('select_statusEstufa');
        let empresaInput = document.getElementById('select_empresa');
        let tempMaxInput = document.getElementById('input_TemperaturaMax');
        let tempMinInput = document.getElementById('input_TemperaturaMin');
        let UmidMaxInput = document.getElementById('input_umidadeMax');
        let UmidMinInput = document.getElementById('input_umidadeMIn');

        let tamanhoEstufa = tamanhoInput.value;
        let statusEstufa = statusInput.value;
        let idEmpresa = empresaInput.value;
        let TempMaxima = tempMaxInput.value;
        let TempMinima = tempMinInput.value;
        let UmidMaxima = UmidMaxInput.value;
        let UmidMinima = UmidMinInput.value;

        tamanhoInput.style.borderColor = '';
        statusInput.style.borderColor = '';
        empresaInput.style.borderColor = '';
        tempMaxInput.style.borderColor = '';
        tempMinInput.style.borderColor = '';
        UmidMaxInput.style.borderColor = '';
        UmidMinInput.style.borderColor = '';
        

        let validacao = true;
        let mensagensAlerta = [];

        if (tamanhoEstufa === '') {
            marcarErro(tamanhoInput);
            mensagensAlerta.push('Tamanho inválido!');
            validacao = false;
        }

        if (statusEstufa === '' ) {
            marcarErro(statusInput);
            mensagensAlerta.push('Insira um status!');
            validacao = false;
        }

        if (idEmpresa === '') {
            marcarErro(empresaInput);
            mensagensAlerta.push('Insira uma empresa!');
            validacao = false;
        }

        if (TempMaxima === '' || TempMinima === '' || UmidMaxima === '' || UmidMinima === '') {
            marcarErro(tempMaxInput);
            marcarErro(tempMinInput);
            marcarErro(UmidMaxInput);
            marcarErro(UmidMinInput);
            mensagensAlerta.push('Insira parâmetros válidos!');
            validacao = false;
        }

        if (!validacao) {
            let mensagemAlerta = 'Preencha todos os campos!';
            if (mensagensAlerta.length > 0) {
                    mensagemAlerta = mensagensAlerta.join('<br>'); 
            }
            mostrarAlerta(mensagemAlerta);
        }else{
            fetch('./estufas/cadastrar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    tamanhoServer: tamanhoEstufa,
                    statusServer: statusEstufa,
                    empresaServer: idEmpresa,
                    TempMaximaServer: TempMaxima,
                    TempMinimaServer: TempMinima,
                    UmidMaximaServer: UmidMaxima,
                    UmidMinimaServer: UmidMinima

                })
            })
                .then(function (resposta) {
                    if (resposta.ok) {
                        setTimeout(() => {
                            let mensagemSucesso = 'Estufa Cadastrada com Sucesso.'
                            let titleAlerta = document.querySelector('.textAlerta')

                            titleAlerta.innerHTML = 'Cadastro Efetuado!'
                            mostrarAlerta(mensagemSucesso)
                        }, 1000);
                    }
            })
        }
    }
        
        
 
</script>